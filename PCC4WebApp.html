<!DOCTYPE html>
<html>
<head>
<title>HTML5 WebBLE Gateway for heart rate</title>
<style type="text/css">
    canvas { border: 1px solid black; }
    textarea { resize: both; font-family: Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New, monospace; }
    div.bpm { display: inline; }
    #bpmValue { padding-left: 10px; padding-right: 10px; font-weight: bold; }
    #myCanvas,
    #plotlyGauge,
    #plotlyBar {
        display: inline-block;
        vertical-align: top;
    }
    
    /* Adjust the width of the plotly bar */
    #plotlyBar {
        width: 200px; /* Set your desired width */
        display: inline-block;
        vertical-align: top;
    }
    
    #plotlyGauge {
        margin-left: 20px;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.css">

</head>
<body onload="init();">


<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/mode/javascript/javascript.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<p>
<div class="bpm">CPR Rate:</div>
<div class="bpm" id="bpmValue">60</div>
<div class="bpm">BPM</div>
</p>

<canvas id="myCanvas" width="400" height="341"></canvas>
<div id="plotlyGauge" ></div>
<div id="plotlyBar" ></div>
<p>
<button onclick="start()">Start sensor</button>
<button onclick="stop()">Stop sensor</button>
</p>


<script>
                                         
var canvas, ctx, val, requestId;

var signal;
var signalArray = [];
var filterArray = [];
var threshold = 2000;

var oldTime;

var targetDevice;
var charUARTRX;
var myFunction;

const BLE_UART_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const BLE_UART_RX_CHAR = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

// Create the data for the plot
var data = [{
    type: "indicator",
    mode: "gauge",
    value: 110,
    title: {text: "CPR Rate"},
    domain: {x: [0, 1], y: [0, 1]},
    gauge: { axis: { visible: false, range: [60, 160] },
          bar: { color: 'navy'},
          steps: [
        { range: [60, 90], color: 'salmon' },
        { range: [90, 100], color: 'lightyellow' },
        { range: [100, 120], color: 'palegreen' },
        { range: [120, 130], color: 'lightyellow' },
        { range: [130, 160], color: 'salmon' }
           ]
           }
}];

// Create the layout for the plot
var layout = {
    width: 500,
    height: 400,
    margin: {t: 0, b: 0, l: 0, r: 0},
    paper_bgcolor: "white",
    font: {color: "black"}
};

function createPlotlyBar(data) {
    var plotlyData = [{
        x: ['Pressure Level'],
        y: [data],
        type: 'bar',
        orientation: 'v'
    }];

    var layout = {
        yaxis: {
            range: [0, threshold], // Define the range of the x-axis (adjust as needed)
            showticklabels: false // Hide y-axis scale
        },
        margin: {t: 50, b: 120, l: 50, r: 50} // Move the bar graph 50 points up
    };

    Plotly.newPlot('plotlyBar', plotlyData, layout);
}


// Update the Plotly graph when new data is received
function updatePlotlyBar(newValue, lastValue, lastlastValue) {
    // checks for a peak in the data
    if (newValue < lastValue && lastValue > lastlastValue) {
        if (lastValue > threshold) { // if the peak is above the threshold
            Plotly.restyle('plotlyBar', 'x', [['Good Pressure']]);
            Plotly.restyle('plotlyBar', 'marker.color', ['green']);
        }
       else {
            Plotly.restyle('plotlyBar', 'x', [['Not enough Pressure']]);
            Plotly.restyle('plotlyBar', 'marker.color', ['red']);
        }
    };
    Plotly.restyle('plotlyBar', 'y', [[newValue]]);

}


function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function init()
{
    canvas = document.getElementById('myCanvas');
    val = document.getElementById('bpmValue');
    ctx = canvas.getContext('2d');
    for (i=0; i < canvas.width/2; i++) {
        signalArray.push(100);
        filterArray.push(100);
    }
    oldTime = new Date();
    console.log("init");
    Plotly.newPlot('plotlyGauge', data, layout);

    // Call the function to create the Plotly graph with initial data
    createPlotlyBar(10); // Assuming initial value is 0

    
}

function startBluetooth()
{
    console.log('Requesting Bluetooth Device...');
    navigator.bluetooth.requestDevice({filters: [                                                                                   {services: [BLE_UART_SERVICE]},
                                          {namePrefix: 'BBC micro:bit '}]})
    .then(device => {
          console.log('Connecting to GATT Server...');
          targetDevice = device;
          return device.gatt.connect();
    })
    .then(server => {
          console.log('Getting Service...');
          return server.getPrimaryService(BLE_UART_SERVICE);
    })
    .then(service => {
          console.log('Got service');
          return service.getCharacteristic(BLE_UART_RX_CHAR);
    })
    .then(characteristic => {
          console.log('Got char');
          charUARTRX = characteristic;
          return charUARTRX.startNotifications();
    })
    .then(_ => {
          console.log('Notifications started');
          charUARTRX.addEventListener('characteristicvaluechanged',
                                            handleNotifications);
    })
    .catch(error =>{
         console.log(error);
    });
}

function animationLoop(timestamp)
{
    //console.log("animate");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.font = "12px Arial";
    ctx.fillStyle = "#FF0000";
    ctx.strokeStyle = "#000000";
    
    //var ctx = c.getContext("2d");
    ctx.beginPath(0, canvas.height - signalArray[0]*canvas.height/1023);
    for(i = 1; i < signalArray.length; i++){
        ctx.lineTo(2*i, canvas.height - signalArray[i]*canvas.height/1023);
    }
    ctx.stroke();
    
    ctx.strokeStyle = "#FF0000";
    ctx.beginPath(0, canvas.height - filterArray[0]*canvas.height/1023);
    for (i = 1; i < filterArray.length; i++) {
        ctx.lineTo(2*i, canvas.height - filterArray[i]*canvas.height/1023);
    }
    ctx.stroke();
    
    requestId = requestAnimationFrame(animationLoop);

}
function updatePlot(newVal, iscpr) {
    // Update the value
    if (iscpr == 0) {
        data[0].title = "No CPR";
        data[0].value = 0;
    } else { 
        data[0].value = newVal;
        if (newVal < 100) {
            data[0].title = "Too slow";
        } else if (newVal > 120) {
            data[0].title = "Too fast";
        } else {
            data[0].title = "Good";
        }
    }
    

    // Replot the plot
    Plotly.react('plotlyGauge', data, layout);
}

function handleNotifications(event){
    var result = "";
    for (i = 0; i < event.target.value.byteLength; i++) {
        result += String.fromCharCode(event.target.value.getUint8(i));
    }

    console.log(result);
    var values = result.split(' ');
    
    if (values[0] == "BPM") {
        setBPM(parseInt(values[1]));
        return;
    }
    
    signal = parseInt(values[0]);
    
    signalArray.shift();
    signalArray.push(signal);
  
    


    if (myFunction) {
        eval(myFunction);
        return;
    }
    
    if (values.length >= 2) {
        filterArray.shift();
        filterArray.push(parseInt(values[1]));
    }
    
    if (values.length >= 3) {
        setBPM(parseInt(values[2]));
    }

    updatePlot(parseInt(values[2]), parseInt(values[3]));
    // Call this function whenever you receive new data
    updatePlotlyBar(signalArray[signalArray.length - 1], signalArray[signalArray.length - 2], signalArray[signalArray.length - 3]);
}

function setBPM(bpm)
{
    val.textContent = bpm;
}

function setMean(mean)
{
    filterArray.shift();
    filterArray.push(mean);
}

function runningTime()
{
    return Date.now()
}

function blink(onoff)
{
    if (onoff)
        val.style.background = "#F55";
    else
        val.style.background = "#FFF";
}


function start()
{
    startBluetooth();
    requestId = requestAnimationFrame(animationLoop);
}


function stop()
{
    if (requestId) {
        cancelAnimationFrame(requestId);
    }
    
    if (charUARTRX) {
        charUARTRX.stopNotifications()
        .then(_ => {
            console.log('Notifications stopped');
            charUARTRX.removeEventListener('characteristicvaluechanged',
                                           handleNotifications);
            charUARTRX = null;
            targetDevice.gatt.disconnect();
        })
        .catch(error => {
            console.log('Argh! ' + error);
        });
    }
}


</script>
</body>
</html>
