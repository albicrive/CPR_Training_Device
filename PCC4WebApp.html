<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Today's heart rate</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="jqFhir.js"></script>
</head>
<body>

    <div id="plot_area" style="width:1000px;height:350px;"></div>

    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script type="module">
        const startingvalues = 30;  //initial values
        var HRvalues = [];
        var Dates = [];
        var lastdate = new Date();
        lastdate.setMinutes(lastdate.getMinutes() - 30); //gets only values from the last x min
        console.log(lastdate);

    async function GetHR(){

        var client = jqFhir({ baseUrl: 'https://hapi.prod.cloud.cbh.kth.se/fhir' });


        let searchParams = new URLSearchParams(window.location.search)
        searchParams.has('id')
        var patientId = searchParams.get('id') //gets patientid from searchbar

        const today = new Date();

        client.search({
          type: 'Observation',
          query: {
            _count: startingvalues,
            patient: {
              $type: 'Patient',
              _id: patientId
            },
            date :{
              $gt: lastdate.toISOString()
            },  
              _sort: 'date'
          }}).then(res => {
            console.log(res);
            console.log("res");

            for (const entry of res.entry) {
        

                if(HRvalues.length > startingvalues)  {
                  Dates.shift();
                  HRvalues.shift();
                }
                Dates.push(new Date(entry.resource.effectiveInstant));
                HRvalues.push(entry.resource.valueQuantity.value);
                lastdate = new Date(entry.resource.effectiveInstant);
        }

        console.log(lastdate);
      }).then(plot);
      };



/*
        async function GetHR1(){
        var client = jqFhir({ baseUrl: 'https://hapi.prod.cloud.cbh.kth.se/fhir' });

        let searchParams = new URLSearchParams(window.location.search)
        searchParams.has('id')
        var patientId = searchParams.get('id')
        console.log("GetID");

        const today = new Date();

        client.search({
          type: 'Observation',
          query: {
            _count: 10,
            patient: {
              $type: 'Patient',
              _id: patientId
            },
            date :{
              $gt: lastdate.toISOString()
            },
            _sort: '-date'
          }}).then(res => {
            console.log(res);
            for (const entry of res.entry) {
        
              console.log("lastdate", lastdate.toISOString());
              console.log("newentry", entry.resource.effectiveInstant);

                  Dates.push(new Date(entry.resource.effectiveInstant));
                  lastdate = new Date(entry.resource.effectiveInstant);
                  HRvalues.push(entry.resource.valueQuantity.value);
                  console.log("^This one^")
            
        }
      }).then(plot);
      };
*/




    async function plot(){
      console.log(HRvalues);
      console.log(Dates);
      Plotly.purge("plot_area");
      const plotly_elem = document.getElementById('plot_area');
        const plotly_layout = {
          margin: {t: 50},
          title: 'Heart Rate (Beats per Minute)',
          grid: { rows: 1, columns: 2, pattern: "independent" }
        };
        const x1 = Array.from({ length: HRvalues.length }, (_, index) => index);
        const plotly_data = [{
          x: Dates,
          y: HRvalues,
          type: 'scatter', 
          name: 'heartrate'
        },{
          type: "indicator", value: HRvalues[HRvalues.length-1], // Most recent value
          mode: "gauge+number+delta",
          delta: { reference: HRvalues[HRvalues.length-2] }, //Last Value 
          gauge: { axis: { visible: false, range: [0, 200] },
          bar: { color: 'navy'},
          steps: [
        { range: [0, 30], color: 'salmon' },
        { range: [30, 50], color: 'lightyellow' },
        { range: [50, 90], color: 'palegreen' },
        { range: [90, 110], color: 'lightyellow' },
        { range: [110, 200], color: 'salmon' }
           ]
           }, 
          domain: { row: 0, column: 1 
          }
     }];


        Plotly.newPlot(plotly_elem, plotly_data, plotly_layout);
      }




      GetHR();




      const interval = window.setInterval(function() {
        GetHR();
 }, 15000);

    </script>
</body>
</html>
